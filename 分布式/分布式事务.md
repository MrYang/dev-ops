# 分布式事务

## 理论

### 2PC, 3PC

[参考](https://github.com/MrYang/dev-ops/blob/master/分布式/基础.md)

### XA

- AP(Application Program) 应用程序
- TM(Transaction Manager)（全局）事务管理器，通常是应用程序来担当该角色，与多个RM(数据库实例)通信
- RM(Resource Manager)通常是数据库

### 事务补偿

涉及两个进程的操作需要保证原子性，进程间RPC通信，那么一般是A进程先执行，然后RPC调用B进程接口，根据B进程的返回结果，绝对是否回滚（补偿）

缺点：涉及到异步RPC、多线程、或者两个以上进程的通讯，就不一定能补偿、甚至很难补偿了，这个时候只能记录一个error 人工排查。因此，

使用场景：事务补偿只适合业务比较简单的场景。

### 基于消息的分布式事务

事务机制将分布式事务分成多个本地事务，首先事务A本地先行提交，然后通过消息通知事务B，事务B从消息中获取信息进行本地提交。这是一种异步事务机制、能保证最终一致性；可用性非常高，不会因为故障而发生阻塞。

缺点：事务A已经先行提交，如果因为事务B无法提交，要回滚事务A比较麻烦。需要做事务补偿发消息给事务A的业务。

使用场景：适用于理论上大概率等成功的业务情况，即事务B的提交失败可能是由于故障，而不大可能是逻辑错误。

可使用数据库表或者MQ存储消息，实现过程保证消息的成功发送及成功消费。需要通过业务系统控制MQ的消息状态。

### 接口幂等

## 实践

假设有A,B,C 三个系统

- A 通过RPC调用B 系统，然后发送一个消息到MQ,C 系统消费这个消息，通过重试，接口幂等保证C 事务的执行。如果C 事务执行失败，需要另外发消息给A， 做事务补偿
- A 通过RPC调用B,C系统，B 成功，C 失败，可用数据库表记录C 失败情况，跟A,B 系统做对比，算是一个补偿事务